<!-- Payment Section - Updated with Complete Cart Integration -->
<div class="payment-container">
  <!-- Discount Code Section -->
  <div class="discount-code-section">
    <h3>{{ 'musicado.discount_code_title' | t }}</h3>
    <div class="discount-input-container">
      <input type="text" id="discountCodeInput" name="discountCode" placeholder="{{ 'musicado.discount_code_placeholder' | t }}">
      <button type="button" onclick="window.MusicadoApp && window.MusicadoApp.applyDiscountCode()" class="btn discount-apply-btn">
        {{ 'musicado.apply_discount' | t }}
      </button>
    </div>
    <div id="discountMessage" class="discount-message" style="display: none;"></div>
  </div>

  <!-- Payment Section - Hide for contact requests -->
  <div class="stripe-form" id="paymentSection">
    <h3>{{ 'musicado.payment_info' | t }}</h3>
    <p class="payment-notice">{{ section.settings.payment_notice | default: 'Secure payment processing powered by Shopify' }}</p>
    
    <!-- Shopify Checkout Integration -->
    <form action="{{ routes.cart_add_url }}" method="post" enctype="multipart/form-data" id="AddToCartForm" class="cart-form">
      <!-- Dynamic product variant ID - will be set by JavaScript -->
      <input type="hidden" name="id" value="" class="product-variant-id" id="dynamicVariantId">
      <input type="hidden" name="quantity" value="1">
      
      <!-- Cart Properties - Order Details -->
      <input type="hidden" name="properties[Package]" id="packageProperty" value="">
      <input type="hidden" name="properties[Music Style 1]" id="style1Property" value="">
      <input type="hidden" name="properties[Music Style 2]" id="style2Property" value="">
      <input type="hidden" name="properties[Voice Preference]" id="voiceProperty" value="">
      <input type="hidden" name="properties[Song Language]" id="languageProperty" value="">
      <input type="hidden" name="properties[Reason]" id="reasonProperty" value="">
      <input type="hidden" name="properties[Words/Names]" id="wordsProperty" value="">
      <input type="hidden" name="properties[Customer Details]" id="customerProperty" value="">
      
      <!-- Optional Properties -->
      <input type="hidden" name="properties[Artists]" id="artistsProperty" value="">
      <input type="hidden" name="properties[Song Titles]" id="titlesProperty" value="">
      <input type="hidden" name="properties[Own Lyrics]" id="lyricsProperty" value="">
      <input type="hidden" name="properties[Discount Applied]" id="discountProperty" value="">
      <input type="hidden" name="properties[Final Price]" id="finalPriceProperty" value="">
      
      <!-- Payment Button -->
      <button type="button" onclick="processPayment()" class="btn payment-btn" id="paymentButton">
        <span class="button-text">{{ 'musicado.pay_now' | t }}</span>
        <span class="button-loading" style="display: none;">
          <span class="loading-spinner"></span>
          {{ 'musicado.processing' | t: default: 'Processing...' }}
        </span>
      </button>
      
      <!-- Payment Security Notice -->
      <div class="payment-security">
        <p>ðŸ”’ {{ 'musicado.secure_payment_notice' | t: default: 'Your payment information is secure and encrypted' }}</p>
      </div>
    </form>
    
    <!-- Payment Error Display -->
    <div id="paymentError" class="payment-error" style="display: none;">
      <p class="error-message"></p>
      <button type="button" onclick="retryPayment()" class="btn btn-secondary">
        {{ 'musicado.try_again' | t: default: 'Try Again' }}
      </button>
    </div>
  </div>

  <!-- Contact Request Section - Show for contact requests -->
  <div class="contact-request-section" id="contactSection" style="display: none;">
    <h3>{{ 'musicado.contact_request' | t }}</h3>
    <div class="contact-notice">
      <p>{{ 'musicado.contact_notice' | t }}</p>
    </div>
    
    <button type="button" onclick="processPayment()" class="btn contact-btn">
      {{ 'musicado.submit_request' | t }}
    </button>
    
    <div class="contact-info">
      <p>
        <strong>{{ 'musicado.alternative_contact' | t: default: 'Or contact us directly:' }}</strong><br>
        ðŸ“§ {{ section.settings.contact_email | default: 'contact@musicado.nl' }}<br>
        ðŸ“ž {{ section.settings.phone_number | default: '+31 6 12345678' }}
      </p>
    </div>
  </div>

  <!-- Order Summary Reminder -->
  <div class="order-reminder">
    <h4>{{ 'musicado.important_info' | t }}</h4>
    <ul>
      <li>{{ 'musicado.delivery_time' | t }}</li>
      <li>{{ 'musicado.personal_use_only' | t: default: 'Songs are for personal use only' }}</li>
      <li>
        {{ 'musicado.questions_contact' | t: default: 'Questions?' }} 
        <a href="mailto:{{ section.settings.contact_email | default: 'contact@musicado.nl' }}" class="contact-link">
          {{ section.settings.contact_email | default: 'contact@musicado.nl' }}
        </a>
      </li>
    </ul>
  </div>
</div>

<!-- JavaScript Functions -->
<script>
  // Global payment processing function
  function processPayment() {
    if (window.MusicadoApp && window.MusicadoApp.processPayment) {
      window.MusicadoApp.processPayment();
    } else {
      console.error('MusicadoApp not loaded');
      alert('{{ "musicado.app_error" | t: default: "Application error. Please refresh the page." }}');
    }
  }

  // Retry payment function
  function retryPayment() {
    const errorDiv = document.getElementById('paymentError');
    const paymentSection = document.getElementById('paymentSection');
    
    if (errorDiv) errorDiv.style.display = 'none';
    if (paymentSection) paymentSection.style.display = 'block';
    
    // Reset button state
    resetPaymentButton();
  }

  // Reset payment button to initial state
  function resetPaymentButton() {
    const button = document.getElementById('paymentButton');
    if (button) {
      button.disabled = false;
      button.querySelector('.button-text').style.display = 'inline';
      button.querySelector('.button-loading').style.display = 'none';
    }
  }

  // Show payment loading state
  function showPaymentLoading() {
    const button = document.getElementById('paymentButton');
    if (button) {
      button.disabled = true;
      button.querySelector('.button-text').style.display = 'none';
      button.querySelector('.button-loading').style.display = 'inline-flex';
    }
  }

  // Show payment error
  function showPaymentError(message) {
    const errorDiv = document.getElementById('paymentError');
    const paymentSection = document.getElementById('paymentSection');
    
    if (errorDiv && paymentSection) {
      errorDiv.querySelector('.error-message').textContent = message;
      errorDiv.style.display = 'block';
      paymentSection.style.display = 'none';
    }
    
    resetPaymentButton();
  }

  // Make functions globally available
  window.showPaymentLoading = showPaymentLoading;
  window.showPaymentError = showPaymentError;
  window.resetPaymentButton = resetPaymentButton;

  // Set theme settings for JavaScript
  window.themeSettings = {
    singleSongVariantId: '{{ section.settings.single_song_variant_id }}',
    epVariantId: '{{ section.settings.ep_variant_id }}',
    albumVariantId: '{{ section.settings.album_variant_id }}',
    defaultDiscountCode: '{{ section.settings.default_discount_code | default: "15%MUSIC" }}',
    discountPercentage: {{ section.settings.discount_percentage | default: 15 }}
  };
</script>

<!-- CSS Styles -->
<style>
  .payment-container {
    max-width: 600px;
    margin: 0 auto;
  }

  .discount-code-section {
    background: rgba(59, 130, 246, 0.05);
    border: 1px solid rgba(59, 130, 246, 0.2);
    border-radius: 12px;
    padding: 1.5rem;
    margin-bottom: 2rem;
  }

  .discount-code-section h3 {
    color: #3b82f6;
    margin-bottom: 1rem;
    font-size: 1.2rem;
  }

  .discount-input-container {
    display: flex;
    gap: 0.5rem;
    margin-bottom: 1rem;
  }

  .discount-input-container input {
    flex: 1;
    padding: 12px;
    border: 1px solid rgba(255, 255, 255, 0.2);
    border-radius: 8px;
    background: rgba(15, 23, 42, 0.4);
    color: #e2e8f0;
  }

  .discount-apply-btn {
    padding: 12px 20px;
    background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
    border: none;
    border-radius: 8px;
    color: #1e293b;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    white-space: nowrap;
  }

  .discount-apply-btn:hover {
    background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
    transform: translateY(-2px);
  }

  .discount-apply-btn:disabled {
    opacity: 0.6;
    cursor: not-allowed;
    transform: none;
  }

  .discount-message {
    padding: 10px;
    border-radius: 6px;
    font-size: 0.9rem;
    font-weight: 500;
  }

  .discount-message.success {
    background: rgba(16, 185, 129, 0.1);
    border: 1px solid rgba(16, 185, 129, 0.3);
    color: #10b981;
  }

  .discount-message.error {
    background: rgba(239, 68, 68, 0.1);
    border: 1px solid rgba(239, 68, 68, 0.3);
    color: #ef4444;
  }

  .stripe-form {
    background: rgba(30, 41, 59, 0.4);
    border: 1px solid rgba(59, 130, 246, 0.3);
    border-radius: 12px;
    padding: 2rem;
    margin-bottom: 2rem;
  }

  .stripe-form h3 {
    color: #3b82f6;
    margin-bottom: 0.5rem;
    font-size: 1.3rem;
  }

  .payment-notice {
    color: #cbd5e1;
    margin-bottom: 1.5rem;
    font-size: 0.95rem;
  }

  .payment-btn {
    width: 100%;
    padding: 16px 24px;
    background: linear-gradient(135deg, #10b981 0%, #059669 100%);
    color: white;
    border: none;
    border-radius: 12px;
    font-size: 1.1rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    position: relative;
    overflow: hidden;
  }

  .payment-btn:hover:not(:disabled) {
    background: linear-gradient(135deg, #059669 0%, #047857 100%);
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(16, 185, 129, 0.4);
  }

  .payment-btn:disabled {
    opacity: 0.7;
    cursor: not-allowed;
    transform: none;
  }

  .button-loading {
    display: none;
    align-items: center;
    gap: 0.5rem;
  }

  .loading-spinner {
    width: 16px;
    height: 16px;
    border: 2px solid rgba(255, 255, 255, 0.3);
    border-top: 2px solid white;
    border-radius: 50%;
    animation: spin 1s linear infinite;
  }

  @keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
  }

  .payment-security {
    text-align: center;
    margin-top: 1rem;
  }

  .payment-security p {
    color: #94a3b8;
    font-size: 0.85rem;
  }

  .payment-error {
    background: rgba(239, 68, 68, 0.1);
    border: 1px solid rgba(239, 68, 68, 0.3);
    border-radius: 12px;
    padding: 1.5rem;
    text-align: center;
  }

  .payment-error .error-message {
    color: #ef4444;
    margin-bottom: 1rem;
    font-weight: 500;
  }

  .contact-request-section {
    background: rgba(251, 191, 36, 0.05);
    border: 1px solid rgba(251, 191, 36, 0.3);
    border-radius: 12px;
    padding: 2rem;
    text-align: center;
  }

  .contact-request-section h3 {
    color: #fbbf24;
    margin-bottom: 1rem;
  }

  .contact-notice {
    margin-bottom: 1.5rem;
  }

  .contact-notice p {
    color: #cbd5e1;
    line-height: 1.6;
  }

  .contact-btn {
    background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
    color: #1e293b;
    margin-bottom: 1.5rem;
    width: 100%;
    padding: 16px 24px;
  }

  .contact-btn:hover {
    background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
  }

  .contact-info {
    background: rgba(15, 23, 42, 0.3);
    border-radius: 8px;
    padding: 1rem;
  }

  .contact-info p {
    color: #cbd5e1;
    font-size: 0.9rem;
    line-height: 1.6;
    margin: 0;
  }

  .contact-link {
    color: #06b6d4;
    text-decoration: none;
    font-weight: 500;
  }

  .contact-link:hover {
    text-decoration: underline;
  }

  .order-reminder {
    background: rgba(15, 23, 42, 0.3);
    border: 1px solid rgba(94, 132, 184, 0.2);
    border-radius: 12px;
    padding: 1.5rem;
  }

  .order-reminder h4 {
    color: #e2e8f0;
    margin-bottom: 1rem;
    font-size: 1.1rem;
  }

  .order-reminder ul {
    list-style: none;
    padding: 0;
    margin: 0;
  }

  .order-reminder li {
    color: #cbd5e1;
    margin-bottom: 0.5rem;
    font-size: 0.9rem;
    line-height: 1.5;
  }

  .order-reminder li:before {
    content: "âœ“";
    color: #10b981;
    font-weight: bold;
    margin-right: 0.5rem;
  }

  /* Mobile Responsiveness */
  @media (max-width: 768px) {
    .payment-container {
      margin: 0;
    }

    .discount-input-container {
      flex-direction: column;
    }

    .discount-apply-btn {
      width: 100%;
    }

    .stripe-form,
    .contact-request-section,
    .order-reminder {
      padding: 1.5rem;
    }
  }
</style>

{% schema %}
{
  "name": "Payment Section",
  "settings": [
    {
      "type": "header",
      "content": "Product Configuration"
    },
    {
      "type": "paragraph",
      "content": "You must create products in your Shopify admin first, then enter the variant IDs here. Go to Products â†’ [Your Product] â†’ Variants to find these IDs."
    },
    {
      "type": "text",
      "id": "single_song_variant_id",
      "label": "Single Song Variant ID",
      "info": "The Shopify variant ID for your single song product"
    },
    {
      "type": "text",
      "id": "ep_variant_id",
      "label": "EP Variant ID",
      "info": "The Shopify variant ID for your EP (4 songs) product"
    },
    {
      "type": "text",
      "id": "album_variant_id",
      "label": "Full Album Variant ID",
      "info": "The Shopify variant ID for your full album product"
    },
    {
      "type": "header",
      "content": "Payment Settings"
    },
    {
      "type": "text",
      "id": "payment_notice",
      "label": "Payment Notice",
      "default": "Secure payment processing powered by Shopify",
      "info": "Text shown above the payment form"
    },
    {
      "type": "header",
      "content": "Discount Settings"
    },
    {
      "type": "text",
      "id": "default_discount_code",
      "label": "Default Discount Code",
      "default": "15%MUSIC",
      "info": "The discount code that customers can use"
    },
    {
      "type": "range",
      "id": "discount_percentage",
      "min": 5,
      "max": 50,
      "step": 5,
      "unit": "%",
      "label": "Discount Percentage",
      "default": 15,
      "info": "Percentage discount to apply with the code"
    },
    {
      "type": "header",
      "content": "Contact Information"
    },
    {
      "type": "text",
      "id": "contact_email",
      "label": "Contact Email",
      "default": "contact@musicado.nl",
      "info": "Email address for customer inquiries"
    },
    {
      "type": "text",
      "id": "phone_number",
      "label": "Phone Number",
      "default": "+31 6 12345678",
      "info": "Phone number for customer support"
    }
  ],
  "presets": [
    {
      "name": "Payment Section"
    }
  ]
}
{% endschema %}
